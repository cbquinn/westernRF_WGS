Run per sample in an array (except for plotting step)

First make list
/group/ctbrowngrp2/cbquinn/fox4/4_SMC/PSMC/pscm.bamlist

```
indelrealigned	RUS_S12-0237	13
indelrealigned	AK_S12-1159	25
subsampled	AK_S12-1159_17x	17
subsampled	AK_S12-1159_13x	13
indelrealigned	ECAN_S14-0358	17
indelrealigned	WAC_S10-0511	25
subsampled	WAC_S10-0511_17x	17
subsampled	WAC_S10-0511_13x	13
indelrealigned	ORC_S17-2544	17
indelrealigned	RM_S13-2260	17
indelrealigned	VT_F12-232	13
indelrealigned	SN_S11-0008 34
indelrealigned	SN_S11-0008_25x 25
indelrealigned	SN_S11-0008_13x 13
```

2 days for bam2fq (<1 G), several hours for next part

/group/ctbrowngrp2/cbquinn/fox4/slurmscripts/psmc.sh
```
#!/bin/bash -l
#SBATCH --job-name=psmc
#SBATCH --array=1-11
#SBATCH --time 3-00:00:00
#SBATCH --mem=3GB
#SBATCH -p bmm
#SBATCH -A ctbrowngrp
#SBATCH -o /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/PSMC_run_%a.out
#SBATCH -e /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/PSMC_run_%a.err

STARTTIME=$(date +%s)

LIST=/group/ctbrowngrp2/cbquinn/fox4/4_SMC/PSMC/pscm.bamlist
BAMDIR=$(sed "${SLURM_ARRAY_TASK_ID}q;d" $LIST | cut -f1)
SAMPLE=$(sed "${SLURM_ARRAY_TASK_ID}q;d" $LIST | cut -f2)
DEPTH_MEAN=$(sed "${SLURM_ARRAY_TASK_ID}q;d" $LIST | cut -f3)
DEPTH_MIN=$(($DEPTH_MEAN / 3))
DEPTH_MAX=$(($DEPTH_MEAN * 2))
REF=/group/ctbrowngrp2/cbquinn/fox4/ref/GCF_018345385.1/GCF_018345385.1_ASM1834538v1_genomic.fna
BED=/group/ctbrowngrp2/cbquinn/fox4/ref/GCF_018345385.1/genmap/artic/GCF_018345385.1_ASM1834538v1_genomic_E2_high_mapability_mask.bed
OUTDIR=/group/ctbrowngrp2/cbquinn/fox4/4_SMC/PSMC
INDIR=/group/ctbrowngrp2/cbquinn/fox4/0_bams

module load samtools/1.14
module load bcftools/1.14

# fail on errors and don't allow unset variables
set –o pipefail
set –o errexit
set –o nounset

##### step 1: bam to fastq #####

# keep only autosomes with high mappability
# call all sites with mpileup
# convert from vcf to fasta

echo "creating fq for sample $SAMPLE and outputting file to $OUTDIR"

samtools view -L $BED -u $INDIR/$BAMDIR/${SAMPLE}.bam | \
samtools mpileup -Q 30 -q 30 -u -v -f $REF - | \
bcftools call -c | \
vcfutils.pl vcf2fq -d 5 -D $DEPTH_MAX -Q 30 | \
gzip > $OUTDIR/fqs/${SAMPLE}.fq.gz

ENDTIME=$(date +%s)
TIMESPEND=$(($ENDTIME - $STARTTIME))
((sec=TIMESPEND%60,TIMESPEND/=60, min=TIMESPEND%60, hrs=TIMESPEND/60))
timestamp=$(printf "%d:%02d:%02d" $hrs $min $sec)
echo "bam to fastq done. Took $timestamp hours:minutes:seconds to complete..."

##### step 2: fastq to fasta #####

STARTTIME=$(date +%s)

/home/sophiepq/bin/psmc/utils/fq2psmcfa $OUTDIR/fqs/${SAMPLE}.fq.gz > $OUTDIR/fas/${SAMPLE}.psmc.fa

##### step 3: execute psmc #####

# test a few different parameter sets

t=15
p="4+25*2+4+6"
dir="t15_4_25x2_4_6"
mkdir -p $OUTDIR/outfiles/$dir
/home/sophiepq/bin/psmc/psmc -t $t -r5 -p $p -o  $OUTDIR/outfiles/$dir/${SAMPLE}.psmc $OUTDIR/fas/${SAMPLE}.psmc.fa

t=15
p="10*1+22*2+4+6"
dir="t15_10x1_25x2_4x2"
mkdir -p $OUTDIR/outfiles/$dir
/home/sophiepq/bin/psmc/psmc -t $t -r5 -p $p -o  $OUTDIR/outfiles/$dir/${SAMPLE}.psmc $OUTDIR/fas/${SAMPLE}.psmc.fa

ENDTIME=$(date +%s)
TIMESPEND=$(($ENDTIME - $STARTTIME))
((sec=TIMESPEND%60,TIMESPEND/=60, min=TIMESPEND%60, hrs=TIMESPEND/60))
timestamp=$(printf "%d:%02d:%02d" $hrs $min $sec)
echo "psmc done. Took $timestamp hours:minutes:seconds to complete..."
```

### convert output to plottable table
```
module load gnuplot

LIST=/group/ctbrowngrp2/cbquinn/fox4/4_SMC/PSMC/pscm.bamlist

INDIR=/group/ctbrowngrp2/cbquinn/fox4/4_SMC/PSMC




# plot without FNR first
for SAMPLE in $(cut -f2 $LIST | tr "\n" " ")
do
cd $INDIR/outfiles/t15_10x1_25x2_4x2
/group/ctbrowngrp2/hennelly/hennelly/bin/psmc/utils/psmc_plot.pl -u 4.5e-09 -g 2 -R ${SAMPLE}_u45e9g2 ${SAMPLE}.psmc
cd $INDIR/outfiles/t15_4_25x2_4_6
/group/ctbrowngrp2/hennelly/hennelly/bin/psmc/utils/psmc_plot.pl -u 4.5e-09 -g 2 -R ${SAMPLE}_u45e9g2 ${SAMPLE}.psmc
done

# plot with false positive rate... for discovery samples
for SAMPLE in WAC_S10-0511_13x WAC_S10-0511_17x AK_S12-1159_13x AK_S12-1159_17x
do
for FNR in $(seq 0.01 0.01 0.1)
do
cd $INDIR/outfiles/t15_10x1_25x2_4x2
/group/ctbrowngrp2/hennelly/hennelly/bin/psmc/utils/psmc_plot.pl -N $FNR -u 4.5e-09 -g 2 -R ${SAMPLE}_u45e9g2_FNR${FNR} ${SAMPLE}.psmc

cd $INDIR/outfiles/t15_4_25x2_4_6
/group/ctbrowngrp2/hennelly/hennelly/bin/psmc/utils/psmc_plot.pl -N $FNR -u 4.5e-09 -g 2 -R ${SAMPLE}_u45e9g2_FNR${FNR} ${SAMPLE}.psmc
done
done  
```
[[PSMC]]