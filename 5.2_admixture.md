## Final run... 
(see https://github.com/dloesch/leverage-ancestry)

/group/ctbrowngrp2/cbquinn/fox4/slurmscripts/admixture.sh
```
#!/bin/bash -l
#SBATCH --job-name=admix
#SBATCH --array=1-15
#SBATCH --nodes 1
#SBATCH --ntasks 1
#SBATCH --cpus-per-task=4
#SBATCH --time 24:00:00
#SBATCH --mem=4GB
#SBATCH -p bmm
#SBATCH -A ctbrowngrp
#SBATCH -o /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/admixture_%a.out
#SBATCH -e /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/admixture_%a.err

INDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/final
OUTDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/admixture/final/all
#program path
admix=/home/sophiepq/admixture_linux-1.3.0/admixture
#data="$INDIR/bcf_variant_filterA_ac1.dp3.mis20_n34_masked_LDpruned.bed"
data="$INDIR/bcf_variant_filterA_ac1.dp3.mis20_n34_masked_LDpruned_reduced.bed"
K=$SLURM_ARRAY_TASK_ID
out=$(basename ${data%.bed})
module load deprecated/plink/1.90

cd $OUTDIR
mkdir -p K${K}
cd K${K}

echo "run   seed" > K${K}.random.txt

#runs 10 replicates
for run in {1..10};
do
    mkdir -p run${run}
    cd run${run}

    #set random seed
    seed=$RANDOM

    $admix --cv=10 $data $K -j4 -s $seed | tee run${run}.K${K}.out

    cd ..
    echo "run${run} $seed" >> K${K}.random.txt
done

scontrol show job ${SLURM_JOB_ID}
sstat --format 'JobID,MaxRSS,AveCPU' -P ${SLURM_JOB_ID}.batch
```

Rerun again with reduced set

--distance 1-ibs?

Then summarize results (run interactively)

```
INDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/final
OUTDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/admixture/final/all
data="$INDIR/bcf_variant_filterA_ac1.dp3.mis20_n34_masked_LDpruned.fam"
# or

INDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/final
OUTDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/admixture/final/reduced
data="$INDIR/bcf_variant_filterA_ac1.dp3.mis20_n34_masked_LDpruned_reduced.fam"

cd $OUTDIR

for K in {1..15}
do
cd K${K}

echo "CV_error" > K${K}.CV_error.txt
echo "loglikelihood" > K${K}.loglikelihood.txt

for run in {1..10}
do
#CV error
cat ./run${run}/run${run}.K${K}.o* | grep CV >> K${K}.CV_error.txt

#loglikelihood
cat ./run${run}/run${run}.K${K}.o* | grep Log | tail -1 >> K${K}.loglikelihood.txt
done

#best loglikelihood
best=$(cat K${K}.loglikelihood.txt | grep Log | cut -d" " -f2 | sort -n | tail -1 | sed 's/-//g')

#summary file
paste K${K}.random.txt K${K}.CV_error.txt K${K}.loglikelihood.txt > K${K}.summary.txt

#best run
cat K${K}.summary.txt | grep "$best" > K${K}.best_run.txt

#create outputfile from best run with column ids
#column id files were made from IID column of PED file

cat $data | cut -f1 -d" " > K${K}.subjects.txt
 
best=$(cat K${K}.best_run.txt | sed "1q;d" | cut -f1 -d" ")
results=$(ls ./$best | grep Q)
paste K${K}.subjects.txt ./$best/$results > K${K}.results.txt

cd ..
done

# get CV errors for best runs
rm bestKruns_statssummary.txt
for K in {1..15}
do
cat K${K}/K${K}.best_run.txt >> bestKruns_statssummary.txt
done

```



These are my trial runs...
/group/ctbrowngrp2/cbquinn/fox4/slurmscripts/admixture.sh
```
#!/bin/bash -l
#SBATCH --job-name=admix
#SBATCH --array=1-15
#SBATCH --nodes 1
#SBATCH --ntasks 1
#SBATCH --time 01:00:00
#SBATCH --mem=8GB
#SBATCH -p bmh
#SBATCH -A ctbrowngrp
#SBATCH -o /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/admixture_%a.out
#SBATCH -e /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/admixture_%a.err

INDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34
OUTDIR=/group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/admixture


module load deprecated/plink/1.90

cd $INDIR 
#i=bcf_variant_filterA_ac1.dp3.mis20_n34_masked.vcf.gz
#i=bcf_variant_filterB_ac1.dp5.mis20_n34_masked.vcf.gz
#i=bcf_variant_filterC_ac3.dp3.mis20_n34_masked.vcf.gz
#i=bcf_variant_filterD_ac3.dp5.mis20_n34_masked.vcf.gz

cd $OUTDIR

VCF=$i
OUT=${i%.vcf.gz}

#/home/sophiepq/admixture_linux-1.3.0/admixture --cv $INDIR/${OUT}_unrelated_order1_LDpruned.bed $SLURM_ARRAY_TASK_ID | tee ${OUT}_unrelated_LDpruned.log${SLURM_ARRAY_TASK_ID}.out

#/home/sophiepq/admixture_linux-1.3.0/admixture --cv $INDIR/${OUT}_unrelated_order1_LDpruned_reduced.bed $SLURM_ARRAY_TASK_ID | tee ${OUT}${OUT}_unrelated_order1_LDpruned_reduced.log${SLURM_ARRAY_TASK_ID}.out

#/home/sophiepq/admixture_linux-1.3.0/admixture --cv $INDIR/${OUT}_unrelated_order1_LDpruned.bed $SLURM_ARRAY_TASK_ID | tee ${OUT}_unrelated_LDpruned.log${SLURM_ARRAY_TASK_ID}.out

# for different LDpruned
/home/sophiepq/admixture_linux-1.3.0/admixture --cv $INDIR/${OUT}_unrelated_order1_50.5.25.bed $SLURM_ARRAY_TASK_ID | tee ${OUT}_unrelated_50.5.25.log${SLURM_ARRAY_TASK_ID}.out

/home/sophiepq/admixture_linux-1.3.0/admixture --cv $INDIR/${OUT}_unrelated_order1_50.5.5.bed $SLURM_ARRAY_TASK_ID | tee ${OUT}_unrelated_50.5.5.log${SLURM_ARRAY_TASK_ID}.out


${OUT}_unrelated_order1_50.5.5
```

```
cd /group/ctbrowngrp2/cbquinn/fox4/1_vcfs/variant/n34/admixture
for i in 
bcf_variant_filterA_ac1.dp3.mis20_n34_masked_unrelated_LDpruned bcf_variant_filterB_ac1.dp5.mis20_n34_masked_unrelated_LDpruned bcf_variant_filterC_ac3.dp3.mis20_n34_masked_unrelated_LDpruned bcf_variant_filterD_ac3.dp5.mis20_n34_masked_unrelated_LDpruned
do
cat ${i}*out | grep CV > ${i}_ADMIXTURE_cv.txt
done

for i in bcf_variant_filterA_ac1.dp3.mis20_n34_masked_unrelated_order1_LDpruned_reduced bcf_variant_filterB_ac1.dp5.mis20_n34_masked_unrelated_order1_LDpruned bcf_variant_filterD_ac3.dp5.mis20_n34_masked*_unrelated_order1_LDpruned_reduced
do
cat ${i}*out | grep CV > ${i}_ADMIXTURE_cv.txt
done


# get sample list
cut -d ' ' -f1 ../bcf_variant_filterA_ac1.dp3.mis20_n34_masked_unrelated_order1_LDpruned.fam > admixture_samplelist.txt

cut -d ' ' -f1 ../bcf_variant_filterA_ac1.dp3.mis20_n34_masked_unrelated_order1_LDpruned_reduced2.fam > admixture_samplelist_reduced2.txt
```