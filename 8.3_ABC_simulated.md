
## Description of models
![[Pasted image 20230829141638.png]]


Sequence of historical events: split, start of bottleneck, end of bottleneck
Subdivided populations are smaller than the ancestral population
We assume a shared historical event causes a contraction in each population, but the severity of reduction is individualistic specific to each population
Rocky Mountains increases after cessation of bottleneck whereas ORC is free to expand or contract 

## Install fastsimcoal
```
cd ~/bin
wget http://cmpg.unibe.ch/software/fastsimcoal2/downloads/fsc27_linux64.zip
unzip fsc27_linux64.zip 
chmod +x fsc27_linux64/fsc27093

```
## running simulations

```
# -n number of simulations to perform per parameter set
# -E number of parameter sets to generate
# -s output DNA as SNP data with a maximum number to output
# -I use infinite sites model
# -d computes the sfs for the derived alleles for each population
# -c number of threads to use (2)
# -B number of batches for multi-threaded run (default=12)

fsc=~/bin/fsc27_linux64/fsc27093
cd /group/ctbrowngrp2/cbquinn/fox4/8_ABC/simulated/out
$fsc -t ../in/scenarioA.tpl -n 1 -e ../in/scenarioA.est -E1 -s 20000 -d -q
```
see page 65 for how to parallelize on different nodes with a sbatch script


1000000 takes 5-10s
migration really slows things down now


this script accepts argument of prefix as $1 e.g., 
`sbatch fastsimcoal_sim.sh scenarioA`

/group/ctbrowngrp2/cbquinn/fox4/slurmscripts/fastsimcoal_sim.sh
```sh
#!/bin/bash -l
#SBATCH --job-name=fsc
#SBATCH --time 5-00:00:00
#SBATCH --mem=6GB
#SBATCH --cpus-per-task=2
#SBATCH -p bmm
#SBATCH -A ctbrowngrp
#SBATCH -o /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim.out
#SBATCH -e /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim.err


fsc=~/bin/fsc27_linux64/fsc27093
cd /group/ctbrowngrp2/cbquinn/fox4/8_ABC/simulated/out
$fsc -t ../in/${1}.tpl -n 1 -e ../in/${1}.est -E10000 -s 22351 -d -q
```

try to parallelize

need to move to scratch directory for space
```
cd /group/ctbrowngrp3/scratch/cbquinn/fox/abc/in
cp /group/ctbrowngrp2/cbquinn/fox4/8_ABC/simulated/in/*tpl ./
cp /group/ctbrowngrp2/cbquinn/fox4/8_ABC/simulated/in/*est ./
```


/group/ctbrowngrp2/cbquinn/fox4/slurmscripts/fastsimcoal_sim_parallel.sh
```sh
#!/bin/bash -l
#SBATCH --job-name=fsc
#SBATCH --time 8-00:00:00
#SBATCH --mem=12GB
#SBATCH --array=1-10
#SBATCH --cpus-per-task=2
#SBATCH -p bmm
#SBATCH -A ctbrowngrp
#SBATCH -o /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim_%A_%a.out
#SBATCH -e /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim_%A_%a.err

fsc=~/bin/fsc27_linux64/fsc27093
cd /group/ctbrowngrp3/scratch/cbquinn/fox/abc/out

echo "run ${SLURM_ARRAY_TASK_ID}: for ${1}"

cp ../in/${1}.tpl ../in/${1}_${SLURM_ARRAY_TASK_ID}.tpl
cp ../in/${1}.est ../in/${1}_${SLURM_ARRAY_TASK_ID}.est

$fsc -t ../in/${1}_${SLURM_ARRAY_TASK_ID}.tpl -n 1 -e ../in/${1}_${SLURM_ARRAY_TASK_ID}.est -E10000 -s 22351 -d -q
```
D = 7269591
E=7269592

### Picking up again after arriving in Missoula...
* reducing the number of SNps to 10,000
* using infinite sites model (-I): "Fsc reports the number of mutations that have occurred, which is the same as the number of polymorphic sites under the infinite site model (-I)"
* changed number of loci generated from 1 million to 500,000
/group/ctbrowngrp2/cbquinn/fox4/slurmscripts/fastsimcoal_sim_parallel2.sh
```
#!/bin/bash -l
#SBATCH --job-name=fsc
#SBATCH --time 3-00:00:00
#SBATCH --mem=20GB
#SBATCH --array=1-30
#SBATCH --cpus-per-task=2
#SBATCH -p bmm
#SBATCH -A ctbrowngrp
#SBATCH -o /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim_%A_%a.out
#SBATCH -e /group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim_%A_%a.err

fsc=~/bin/fsc27_linux64/fsc27093
cd /group/ctbrowngrp3/scratch/cbquinn/fox/abc/out_2

echo "run ${SLURM_ARRAY_TASK_ID}: for ${1}"

cp ../in_2/${1}.tpl ../in_2/${1}_${SLURM_ARRAY_TASK_ID}.tpl
cp ../in_2/${1}.est ../in_2/${1}_${SLURM_ARRAY_TASK_ID}.est

$fsc -t ../in_2/${1}_${SLURM_ARRAY_TASK_ID}.tpl -n 1 -e ../in_2/${1}_${SLURM_ARRAY_TASK_ID}.est -E10000 -s 10000 -d -q -I
```
Submitted batch job 7812239
/group/ctbrowngrp2/cbquinn/fox4/slurmlogs/fastsimcoal_sim_7812239_1.out
^ memoried out

Submitted batch job 7813140 (20 GB, only 500,000 sites)