
## Collate observed together

Match number of joint sfs to number of parameters recorded and then collate

```sh
# convert from 2d to 1d array and remove the monomorphic reference bin

#for s in E
#do
s=E
cd /group/ctbrowngrp3/scratch/cbquinn/fox/abc/out_2
for run in {1..30}
do
rm scenario${s}_${run}/jsfs_scenario${s}.txt
echo $scenario${s}_${run}
for i in {1..1000}
do
FILE=scenario${s}_${run}/scenario${s}_${run}_def${i}_jointDAFpop1_0.obs
sed '1,2d' ${FILE} | cut -f2- | tr '\n' '\t' | cut -f2- >> scenario${s}_${run}/jsfs_scenario${s}_${run}.txt
done
done
#done
```
(modify this so that loop quits if file isn't there...)

Now in R...
```
unset CONDA_EXE
module load R/4.2.3
R
```

This after I moved to Missoula...

```r

library(abc)
library(tidyverse)

# vector of observed summary statistics
# matrix of simulated summary statistics (row=simulation, col=summary stat)
# matrix of simulated parameter values(row=simulation, col=parameter)
# vector of model indices

##### 
##### FUNCTIONS
##### 

read_params <- function(x){
  z <- read.table(x, header=TRUE, fill=TRUE)
  #colClasses = c(rep("numeric", 1), rep("NULL", 2)))
  # remove last row (often incomplete)
  # and remove the last 2 columns (likelihoods)
  z[1:(nrow(z)-1),1:(ncol(z)-2)]
}

read_jsfs <- function(x, n){
  z <- read.table(x)
  z[1:n,]
}



##### 
##### LOAD DATA
##### 

setwd("/group/ctbrowngrp3/scratch/cbquinn/fox/abc")

##### read in params

# list of files
par.simE.files <- paste0("in_2/scenarioE_", 1:30, ".params")
par.simE.list <- lapply(par.simE.files, read_params)

# get number of iterations in each run
n.parE <- unlist(lapply(par.simE.list, nrow))

##### read in joint sfs for simulated runs

sfs.simD.files <- paste0("out/scenarioD_", 1:10, "/jsfs_scenarioD_", 1:10, ".txt")
sfs.simE.files <- paste0("out/scenarioE_", 1:10, "/jsfs_scenarioE_", 1:10, ".txt")

# subset to the first n rows
# (in a lazy loop)
sfs.simD.list <- sfs.simE.list <- vector(mode="list", length=10)

for (i in 1:10){
  sfs.simD.list[[i]] <- read_jsfs(sfs.simD.files[i], n=n.parD[i])
  sfs.simE.list[[i]] <- read_jsfs(sfs.simE.files[i], n=n.parE[i])
}

##### concatenate runs

sfs.simD <- bind_rows(sfs.simD.list)
sfs.simE <- bind_rows(sfs.simE.list)

par.simD <- bind_rows(par.simD.list)
par.simE <- bind_rows(par.simE.list)

# check correspondance
nrow(sfs.simD)==nrow(par.simD)
nrow(sfs.simE)==nrow(par.simE)

# concatenate into a single df
sfs.sim <- bind_rows(sfs.simD, sfs.simE)
par.sim <- bind_rows(par.simD, par.simE)

# create model index
models <- c(
  unlist(lapply(n.parD, function(x)rep("D", x))),
  unlist(lapply(n.parE, function(x)rep("E", x)))
)



##### read in joint sfs for observed pops

# ORC_RM
sfs.obs.RMORC <- read.table("/group/ctbrowngrp2/cbquinn/fox4/8_ABC/observed/easySFS_RM_ORC/fastsimcoal2/jsfs_observed.txt")
# ORC_LAS
sfs.obs.ORCLAS <- read.table("/group/ctbrowngrp2/cbquinn/fox4/8_ABC/observed/easySFS_ORC_LAS/fastsimcoal2/ORC_LASjsfs_observed.txt")


##### 
##### CALCULATE SUMMARY STATISTICS
##### 

##### RM v ORC 

combos <- expand.grid(  paste0("d0.", 0:12), paste0("d1.", 0:12))
header <- combos[-1, ] %>% unite(c(Var1, Var2), col="bin", sep="_") %>% pull

names(sfs.obs) <- names(sfs.sim) <- header

# sites with derived alleles that are polymorphic in pop0 but absent in pop1 (private derived segregating sites -- pop0)
# sites with derived alleles that are fixed in pop1 but polymorphic in pop0 (private reference seg sites -- pop0)
privseg0_derived <- grep("d1.0", header, value=TRUE)[-12]
privseg0_ref <- grep("d1.12", header, value=TRUE)[-12]
privseg0 <- c(privseg0_derived, privseg0_ref)
privseg0 <- grep("d0.12_d1.12", privseg0, value=TRUE, invert=TRUE)

# sites with derived alleles that are polymorphic in pop1 but absent in pop0 (private derived segregating sites -- pop1)
# sites with derived alleles that are fixed in pop0 but polymorphic in pop1 (private reference seg sites -- pop1)
privseg1_derived<- grep("d0.0", header, value=TRUE)[-12]
privseg1_ref <- grep("d0.12", header, value=TRUE)[-12]
privseg1 <- c(privseg1_derived, privseg1_ref)
privseg1 <- grep("d0.12_d1.12", privseg1, value=TRUE, invert=TRUE)

# shared polymorphic sites
poly <- grep("d0.0|d1.0", header, value=TRUE, invert=TRUE) 
poly <- grep("12", poly, value=TRUE, invert=TRUE)

# sites with derived alleles that are fixed in pop0 but absent in pop1
fixed <- c("d0.12_d1.0", "d0.0_d1.12")

##### ORC v LAS

combos <- expand.grid(  paste0("d0.", 0:12), paste0("d1.", 0:10))
header <- combos[-1, ] %>% unite(c(Var1, Var2), col="bin", sep="_") %>% pull

names(sfs.obs) <- header		 
# sites with derived alleles that are polymorphic in pop0 but absent in pop1 (private segregating sites -- pop0)
privseg0 <- grep("d1.0", header, value=TRUE)[-12]

# sites with derived alleles that are polymorphic in pop1 but absent in pop0 (private segregating sites -- pop1)
privseg1 <- grep("d0.0", header, value=TRUE)[-10]

# shared polymorphic sites
poly <- grep("d0.0|d1.0", header, value=TRUE, invert=TRUE) 
poly <- grep("12", poly, value=TRUE, invert=TRUE)
poly <- grep("d1.10", poly, value=TRUE, invert=TRUE)
# sites with derived alleles that are fixed in pop0 but absent in pop1
fixed <- c("d0.12_d1.0", "d0.0_d1.10")

# compute new summary statistics from joint sfs

ss.obs <- as.data.frame(bind_cols(
  privseg0=sfs.obs[,privseg0] %>%
    apply(., 1, sum),
  privseg1=sfs.obs[,privseg1] %>%
    apply(., 1, sum),
  poly=sfs.obs[,poly] %>%
    apply(., 1, sum),
  fixed=sfs.obs[,fixed] %>%
    apply(., 1, sum),
))

ss.sim <- ss.sim/(apply(ss.sim, 1, sum))

save(ss.obs, file = "ss.obs.ORC_LAS.RData")		 
##### save objects

save(ss.obs, file = "ss.obs.RData")

save(ss.sim, file = "ss.sim.RData")
save(par.simD, file = "par.simD.RData")
save(par.simE, file = "par.simE.RData")
save(models, file="models.index.RData")

```



This is before I moved to Missoula...
```r

library(abc)
library(tidyverse)

# vector of observed summary statistics
# matrix of simulated summary statistics (row=simulation, col=summary stat)
# matrix of simulated parameter values(row=simulation, col=parameter)
# vector of model indices

##### 
##### FUNCTIONS
##### 

read_params <- function(x){
  z <- read.table(x, header=TRUE, fill=TRUE)
  #colClasses = c(rep("numeric", 1), rep("NULL", 2)))
  # remove last row (often incomplete)
  # and remove the last 2 columns (likelihoods)
  z[1:(nrow(z)-1),1:(ncol(z)-2)]
}

read_jsfs <- function(x, n){
  z <- read.table(x)
  z[1:n,]
}



##### 
##### LOAD DATA
##### 

setwd("/group/ctbrowngrp3/scratch/cbquinn/fox/abc")

##### read in params

# list of files
par.simD.files <- paste0("in/scenarioD_", 1:10, ".params")
par.simE.files <- paste0("in/scenarioE_", 1:10, ".params")

par.simD.list <- lapply(par.simD.files, read_params)
par.simE.list <- lapply(par.simE.files, read_params)

# get number of iterations in each run
n.parD <- unlist(lapply(par.simD.list, nrow))
n.parE <- unlist(lapply(par.simE.list, nrow))

##### read in joint sfs for simulated runs

sfs.simD.files <- paste0("out/scenarioD_", 1:10, "/jsfs_scenarioD_", 1:10, ".txt")
sfs.simE.files <- paste0("out/scenarioE_", 1:10, "/jsfs_scenarioE_", 1:10, ".txt")

# subset to the first n rows
# (in a lazy loop)
sfs.simD.list <- sfs.simE.list <- vector(mode="list", length=10)

for (i in 1:10){
  sfs.simD.list[[i]] <- read_jsfs(sfs.simD.files[i], n=n.parD[i])
  sfs.simE.list[[i]] <- read_jsfs(sfs.simE.files[i], n=n.parE[i])
}

##### concatenate runs

sfs.simD <- bind_rows(sfs.simD.list)
sfs.simE <- bind_rows(sfs.simE.list)

par.simD <- bind_rows(par.simD.list)
par.simE <- bind_rows(par.simE.list)

# check correspondance
nrow(sfs.simD)==nrow(par.simD)
nrow(sfs.simE)==nrow(par.simE)

# concatenate into a single df
sfs.sim <- bind_rows(sfs.simD, sfs.simE)
par.sim <- bind_rows(par.simD, par.simE)

# create model index
models <- c(
  unlist(lapply(n.parD, function(x)rep("D", x))),
  unlist(lapply(n.parE, function(x)rep("E", x)))
)



##### read in joint sfs for observed pops

# ORC_RM
sfs.obs.RMORC <- read.table("/group/ctbrowngrp2/cbquinn/fox4/8_ABC/observed/easySFS_RM_ORC/fastsimcoal2/jsfs_observed.txt")
# ORC_LAS
sfs.obs.ORCLAS <- read.table("/group/ctbrowngrp2/cbquinn/fox4/8_ABC/observed/easySFS_ORC_LAS/fastsimcoal2/ORC_LASjsfs_observed.txt")


##### 
##### CALCULATE SUMMARY STATISTICS
##### 

##### RM v ORC 

combos <- expand.grid(  paste0("d0.", 0:12), paste0("d1.", 0:12))
header <- combos[-1, ] %>% unite(c(Var1, Var2), col="bin", sep="_") %>% pull

names(sfs.obs) <- names(sfs.sim) <- header

# sites with derived alleles that are polymorphic in pop0 but absent in pop1 (private derived segregating sites -- pop0)
# sites with derived alleles that are fixed in pop1 but polymorphic in pop0 (private reference seg sites -- pop0)
privseg0_derived <- grep("d1.0", header, value=TRUE)[-12]
privseg0_ref <- grep("d1.12", header, value=TRUE)[-12]
privseg0 <- c(privseg0_derived, privseg0_ref)
privseg0 <- grep("d0.12_d1.12", privseg0, value=TRUE, invert=TRUE)

# sites with derived alleles that are polymorphic in pop1 but absent in pop0 (private derived segregating sites -- pop1)
# sites with derived alleles that are fixed in pop0 but polymorphic in pop1 (private reference seg sites -- pop1)
privseg1_derived<- grep("d0.0", header, value=TRUE)[-12]
privseg1_ref <- grep("d0.12", header, value=TRUE)[-12]
privseg1 <- c(privseg1_derived, privseg1_ref)
privseg1 <- grep("d0.12_d1.12", privseg1, value=TRUE, invert=TRUE)

# shared polymorphic sites
poly <- grep("d0.0|d1.0", header, value=TRUE, invert=TRUE) 
poly <- grep("12", poly, value=TRUE, invert=TRUE)

# sites with derived alleles that are fixed in pop0 but absent in pop1
fixed <- c("d0.12_d1.0", "d0.0_d1.12")

##### ORC v LAS

combos <- expand.grid(  paste0("d0.", 0:12), paste0("d1.", 0:10))
header <- combos[-1, ] %>% unite(c(Var1, Var2), col="bin", sep="_") %>% pull

names(sfs.obs) <- header		 
# sites with derived alleles that are polymorphic in pop0 but absent in pop1 (private segregating sites -- pop0)
privseg0 <- grep("d1.0", header, value=TRUE)[-12]

# sites with derived alleles that are polymorphic in pop1 but absent in pop0 (private segregating sites -- pop1)
privseg1 <- grep("d0.0", header, value=TRUE)[-10]

# shared polymorphic sites
poly <- grep("d0.0|d1.0", header, value=TRUE, invert=TRUE) 
poly <- grep("12", poly, value=TRUE, invert=TRUE)
poly <- grep("d1.10", poly, value=TRUE, invert=TRUE)
# sites with derived alleles that are fixed in pop0 but absent in pop1
fixed <- c("d0.12_d1.0", "d0.0_d1.10")

# compute new summary statistics from joint sfs

ss.obs <- as.data.frame(bind_cols(
  privseg0=sfs.obs[,privseg0] %>%
    apply(., 1, sum),
  privseg1=sfs.obs[,privseg1] %>%
    apply(., 1, sum),
  poly=sfs.obs[,poly] %>%
    apply(., 1, sum),
  fixed=sfs.obs[,fixed] %>%
    apply(., 1, sum),
))

ss.sim <- ss.sim/(apply(ss.sim, 1, sum))

save(ss.obs, file = "ss.obs.ORC_LAS.RData")		 
##### save objects

save(ss.obs, file = "ss.obs.RData")

save(ss.sim, file = "ss.sim.RData")
save(par.simD, file = "par.simD.RData")
save(par.simE, file = "par.simE.RData")
save(models, file="models.index.RData")

```

